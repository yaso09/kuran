<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Kur'an Okuyucu</title>

<link rel="stylesheet" href="/assets/css/btn.css">
<link rel="stylesheet" href="/assets/css/loadScreen.css">

</head>
<body>
<div class="content">
<div class="arabic">Ø§Ù„Ù‚Ø±Ø¢Ù†</div>  <!-- ArapÃ§a Kur'an -->
<h1>Kur'an</h1><br>
<div class="topbar"><center>
    <button onclick="window.location.href='./'" class="btn">â†</button>
<select id="mealSelect">
    <option value="omer-nasuhi-bilmen" selected>Ã–mer Nasuhi Bilmen</option>
    <option value="hayrat-nesriyat">Hayrat NeÅŸriyat</option>
    <option value="diyanet-vakfi">Diyanet VakfÄ±</option>
</select>
<select id="sureSelect"></select>
<input type="text" id="searchInput" placeholder="Ayet veya iÃ§erik ara...">

<!-- YazdÄ±rma Butonu -->
<button id="printBtn" class="btn">YazdÄ±r</button>
</center></div><br><br>

<div id="ayetler"><div class="loading">YÃ¼kleniyor...</div></div>

<div id="navigationButtons" style="text-align:center; margin-top:20px; display:none;">
  <button id="prevSure" class="btn">â† Ã–nceki Sure</button>
  <button id="nextSure" class="btn">Sonraki Sure â†’</button>
</div>
</div>

<button id="toTopBtn" aria-label="En Ã¼ste Ã§Ä±k">â˜ï¸</button>

<script src="./print.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
function removeDuplicateIds(root = document) {
    document.querySelector("#ayetler").style.display = "none";
    const elements = root.querySelectorAll('[id]'); // NodeList (belge sÄ±rasÄ±na gÃ¶re)
    const seen = new Set();
    let removed = 0;
    // Sonuncuyu korumak iÃ§in sondan baÅŸa doÄŸru dolaÅŸ
    for (let i = elements.length - 1; i >= 0; i--) {
        const el = elements[i];
        const id = el.id;
        if (!id) continue; // boÅŸ id'leri atla (normalde yoktur)
        if (seen.has(id)) {
        // Daha sonra (yani belgedeki sondan Ã¶nceki) ortaya Ã§Ä±kan kopya â€” sil
        el.remove();
        removed++;
        } else {
        // Ä°lk kez gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z (document sÄ±rasÄ±na gÃ¶re sondan ilk) -> sonuncuyu koruyoruz
        seen.add(id);
        }
    }
    document.querySelector("#ayetler").style.display = "block";
    return { removed, kept: seen.size };
}

function removeZiyade() {
    const allVerses = document.querySelectorAll('[id^="verse"]');

    allVerses.forEach(verse => {
        const verseId = verse.id;
        const verseSure = parseInt(verseId.split(":")[0].replace("verse", ""), 10);

        if (!(verseSure == sureSelect.value)) {
            verse.remove();
        }
    })
}

// URL parametresinden sure kontrolÃ¼
function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
}

function scrollToAyet(num = getQueryParam("ayet")) {
    document.getElementById(`verse${sureSelect.value}:${num}`).scrollIntoView({
        behavior: "smooth",
        block: "center"
    })
}

const sureSelect = document.getElementById('sureSelect');
const searchInput = document.getElementById('searchInput');
const mealSelect = document.getElementById("mealSelect");
let allVerses = []; 

const sureNames=[ /* ... liste aynÄ± ÅŸekilde burada ... */ 
"Fatiha","Bakara","Al-i Ä°mran","Nisa","Maide","En'am","A'raf","Enfal","Tevbe","Yunus","Hud","Yusuf","Rad","Ä°brahim",
"Hicr","Nahl","Ä°sra","Kehf","Meryem","Taha","Enbiya","Hac","MÃ¼minun","Nur","Furkan","Åuara","Neml","Kasas","Ankebut","Rum",
"Lukman","Secde","Ahzab","Sebe","FatÄ±r","Yasin","Saffat","Sad","ZÃ¼mer","MÃ¼min","Fussilet","Åura","Zuhruf","Duhan","Casiye","Ahkaf",
"Muhammed","Fetih","Hucurat","Kaf","Zariyat","Tur","Necm","Kamer","Rahman","VakÄ±a","Hadid","MÃ¼cadele","HaÅŸr","MÃ¼mtehine","Saf",
"Cuma","MÃ¼nafikun","Tegabun","Talak","Tahrim","MÃ¼lk","Kalem","Hakka","Mearic","Nuh","Cin","MÃ¼zzemmil","MÃ¼ddessir","KÄ±yamet","Ä°nsan","MÃ¼rselat",
"Nebe","Naziat","Abese","Tekvir","Ä°nfitar","Mutaffifin","Ä°nÅŸikak","BÃ¼ruc","TarÄ±k","A'la","GaÅŸiye","Fecr","Beled","Leyl","Duha",
"Ä°nÅŸirah","Tin","TarÄ±k","Alak","Kadir","Beyyine","Zilzal","Adiyat","Kari'a","TekasÃ¼r","Asr","HÃ¼meze","Fil","KureyÅŸ","Ma'un","Kevser","Kafirun","Nasr","Tebbet","Ä°hlas","Felak","Nas"
];

// Dropdown oluÅŸtur
for(let i=1;i<=114;i++){
    const option=document.createElement('option');
    option.value=i;
    option.textContent=`${i}. ${sureNames[i-1] || 'Sure '+i}`;
    sureSelect.appendChild(option);
}

// Butonlar
const prevSureBtn = document.getElementById('prevSure');
const nextSureBtn = document.getElementById('nextSure');
const navigationDiv = document.getElementById('navigationButtons');

// YazdÄ±rma butonu
const printBtn = document.getElementById('printBtn');
printBtn.addEventListener('click', () => {
    const pdfPath = `./pdf/${sureSelect.value}.pdf`;

    printJS(pdfPath);
});

function updateNavigationButtons(chapter){
    if(!chapter) { navigationDiv.style.display='none'; return; }
    navigationDiv.style.display='block';
    prevSureBtn.disabled = (chapter <= 1);
    nextSureBtn.disabled = (chapter >= 114);
}

prevSureBtn.addEventListener('click',()=>{
    let chap = parseInt(sureSelect.value);
    if(chap > 1){ chap--; sureSelect.value = chap; loadVerse(chap, mealSelect.value); localStorage.setItem('lastChapter', chap); }
});

nextSureBtn.addEventListener('click',()=>{
    let chap = parseInt(sureSelect.value);
    if(chap < 114){ chap++; sureSelect.value = chap; loadVerse(chap, mealSelect.value); localStorage.setItem('lastChapter', chap); }
});

// JSON yÃ¼kleme
async function loadVerse(chapter, meal){
    const container=document.getElementById('ayetler');
    container.innerHTML='<div class="loading">YÃ¼kleniyor...</div>';
    allVerses=[];
    if(!chapter) return window.location.href = "./"; 
    try{
        const response=await fetch(`./data/verses/${chapter}.json`);
        const data=await response.json();
        allVerses=data.verses;
        renderVerses(allVerses, "", meal);
        updateNavigationButtons(parseInt(chapter));
        const scrollTop = localStorage.getItem(`${sureSelect.value}.scrollTop`);
        if (getQueryParam("ayet")) {
            scrollToAyet();
        } else if(scrollTop) {window.scrollTo(0, parseInt(scrollTop));}
    }catch(e){
        container.innerHTML='<div class="loading">Bu sure yÃ¼klenemedi.</div>'; 
        console.error(e);
        navigationDiv.style.display='none';
    }

    removeDuplicateIds();
    removeZiyade();
}

// TÃ¼m Kur'an
async function loadAllVerses(){
    const container=document.getElementById('ayetler');
    container.innerHTML='<div class="loading">YÃ¼kleniyor...</div>';
    allVerses=[];
    for(let i=1;i<=114;i++){
        try{
            const response=await fetch(`/data/verses/${i}.json`);
            const data=await response.json();
            allVerses.push(...data.verses);
        }catch(e){console.error(`Sure ${i} yÃ¼klenemedi`,e);}
    }
    renderVerses(allVerses);
    navigationDiv.style.display='none';
    const scrollTop = localStorage.getItem(`${sureSelect.value}.scrollTop`);
    if (getQueryParam("ayet")) {
        scrollToAyet();
    } else if(scrollTop) window.scrollTo(0, parseInt(scrollTop));
}

async function meal(name, sure, ayet) {
    const response = await fetch(`/data/mealler/${name}.json`);
    const data = await response.json();

    const result = data.sures[sure].ayetler[ayet][1];

    return result;
}

function mark(verseKey) {
    if (!localStorage.getItem("markeds"))
        localStorage.setItem("markeds", "[]");
    if (localStorage.getItem("markeds").search(verseKey) > 0) {
        localStorage.setItem("markeds",
            JSON.stringify(
                JSON.parse(localStorage.getItem("markeds")).filter(
                    n => n !== verseKey
                )
            )
        )
    } else {
        let markeds = JSON.parse(localStorage.getItem("markeds"));
        markeds.push(verseKey);
        localStorage.setItem("markeds", JSON.stringify(markeds));
    }
}

function isMarked(verseKey) {
    if (localStorage.getItem("markeds"))
        return JSON.parse(localStorage.getItem("markeds")).indexOf(verseKey) >= 0;
    else {
        localStorage.setItem("markeds", "[]");
        return false;
    };
}

async function renderVerses(verses, highlight='', mealName="omer-nasuhi-bilmen"){
    const container = document.getElementById('ayetler');
    container.innerHTML = '';
    container.style.display = "none";

    function randomColor() {
        // BeyazÄ± tamamen Ã§Ä±karÄ±yoruz
        const colors = ['#ff6b6b', '#fbc531', '#4cd137', '#00a8ff', '#9c88ff', '#ff9ff3', '#ff4757', '#ff793f', '#3742fa'];
        return colors[Math.floor(Math.random() * colors.length)];
    }

    for (let i = 0; i < verses.length; i++) {
        const ayet = await verses[i];

        const verseDiv = document.createElement('div');
        verseDiv.classList.add('verse');

        const number = document.createElement('div');
        number.classList.add('verse-number');
        number.textContent = `Ayet ${ayet.verseNumber} (${ayet.verseKey})`;

        const arabic = document.createElement('div');
        arabic.classList.add('arabic-text');
        arabic.innerHTML = highlightText(ayet.arabic, highlight);

        const tevil = document.createElement('div');
        tevil.classList.add('english-text');

        const result = await meal(
            mealName,
            ayet.verseKey.split(":")[0] - 1,
            ayet.verseNumber - 1
        )

        tevil.innerHTML = highlightText(result, highlight);

        const markBtn = document.createElement("button");
        markBtn.classList.add("btn");
        //markBtn.style.display = "none";
        markBtn.style.fontSize = "16px";
        markBtn.style.padding = "6px 12px";
        markBtn.style.marginTop = "5px";

        if (isMarked(ayet.verseKey)) {
            verseDiv.style.backgroundColor = "#ffe9c9";
            verseDiv.style.borderRadius = "14px";
            verseDiv.style.border = "10px #ffe9c9 solid";
            markBtn.textContent = "ğŸ¤© Ä°ÅŸaretlemeyi KaldÄ±r";
        }
        else {
            markBtn.textContent = "â­ Ä°ÅŸaretle";
        }

        markBtn.addEventListener("click", function() {
            if (isMarked(ayet.verseKey)) {
                markBtn.textContent = "â­ Ä°ÅŸaretle";
                verseDiv.style.backgroundColor = "#fff";
                verseDiv.style.borderRadius = "0";
                verseDiv.style.border = "0";
            } else {
                markBtn.textContent = "ğŸ¤© Ä°ÅŸaretlemeyi KaldÄ±r";
                verseDiv.style.backgroundColor = "#ffe9c9";
                verseDiv.style.borderRadius = "14px";
                verseDiv.style.border = "10px #ffe9c9 solid";
            }
            
            mark(ayet.verseKey)
        })

        const shareBtn = document.createElement('button');
        shareBtn.textContent = 'ğŸ“¤ PaylaÅŸ';
        shareBtn.classList.add('btn');
        shareBtn.style.fontSize = '16px';
        shareBtn.style.padding = '6px 12px';
        shareBtn.style.marginTop = '5px';

        shareBtn.addEventListener('click', async () => {
            const width = 1080;
            const height = 1080;
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');

            // Rastgele gradient arka plan (beyaz yok)
            const gradient = ctx.createLinearGradient(0, 0, 0, height);
            gradient.addColorStop(0, randomColor());
            gradient.addColorStop(0.5, randomColor());
            gradient.addColorStop(1, randomColor());
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);

            // Soft glow radial patlamalar
            for(let i=0;i<4;i++){
                const radius = Math.random()*400 + 200;
                const x = Math.random()*width;
                const y = Math.random()*height;
                const glow = ctx.createRadialGradient(x, y, 0, x, y, radius);
                glow.addColorStop(0,'rgba(255,255,255,0.08)');
                glow.addColorStop(1,'rgba(255,255,255,0)');
                ctx.fillStyle = glow;
                ctx.fillRect(0,0,width,height);
            }

            // Hafif geometrik desen
            for(let i=0;i<150;i++){
                ctx.fillStyle = `rgba(255,255,255,${Math.random()*0.05})`;
                const x = Math.random()*width;
                const y = Math.random()*height;
                const r = Math.random()*3+1;
                ctx.beginPath();
                ctx.arc(x,y,r,0,2*Math.PI);
                ctx.fill();
            }

            // Ayeti ortala
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#ffffff'; // Beyaz metin

            // ArapÃ§a ayet
            ctx.font = 'bold 80px Kitab, serif';
            ctx.shadowColor = 'rgba(0,0,0,0.3)';
            ctx.shadowBlur = 10;
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;

            const arabicLines = ayet.arabic.split(/\n/);
            const arabicLineHeight = 90;
            let arabicHeight = arabicLines.length * arabicLineHeight;
            let y = (height - arabicHeight) / 2 - 50;

            arabicLines.forEach(line => {
                ctx.fillText(line, width/2, y);
                y += arabicLineHeight;
            });

            // Ä°ngilizce Ã§eviri + ayet numarasÄ±
            ctx.shadowColor = 'transparent';
            ctx.fillStyle = '#ffffff';
            ctx.font = '36px Arial, sans-serif';

            const englishText = result + ` [${ayet.verseKey}]`;
            const words = englishText.split(' ');
            const maxWidth = width - 100;
            const lineHeight = 44;
            let line = '';
            let englishLines = [];

            words.forEach((word, idx) => {
                const testLine = line + (line ? ' ' : '') + word;
                const metrics = ctx.measureText(testLine);
                if(metrics.width > maxWidth){
                    englishLines.push(line);
                    line = word;
                } else {
                    line = testLine;
                }
                if(idx === words.length - 1) englishLines.push(line);
            });

            y += 20;
            englishLines.forEach(el => {
                ctx.fillText(el, width/2, y);
                y += lineHeight;
            });

            // Alt site adÄ± - beyaz
            ctx.font = '24px Arial, sans-serif';
            ctx.fillStyle = '#ffffff';
            ctx.fillText('kuran.yasireymen.com', width/2, height - 40);

            // GÃ¶rseli paylaÅŸ
            canvas.toBlob(blob => {
                const filesArray = [new File([blob], 'ayet.png', {type: 'image/png'})];
                if (navigator.canShare && navigator.canShare({files: filesArray})) {
                    navigator.share({
                        files: filesArray,
                        title: 'Ayet PaylaÅŸÄ±mÄ±',
                        text: ayet.english
                    }).catch(err => console.error('PaylaÅŸÄ±m hatasÄ±:', err));
                } else {
                    alert('Bu cihaz resim paylaÅŸÄ±mÄ±nÄ± desteklemiyor.');
                }
            });
        });

        const embedBtn = document.createElement("button");
        embedBtn.textContent = "ğŸ”— GÃ¶m"
        embedBtn.classList.add("btn");
        embedBtn.style.fontSize = "16px";
        embedBtn.style.padding = '6px 12px';
        embedBtn.style.marginTop = '5px';
        embedBtn.style.marginLeft = '5px';

        embedBtn.addEventListener("click", function() {
            const embedCode = `
            <iframe onload="
            window.addEventListener('message', function(e) {
                if (e.data.embedHeight && e.data.name == '${ayet.verseKey}') {
                    document.getElementById('kuranEmbed${ayet.verseKey}').style.height =
                        e.data.embedHeight + 'px';
                }
            })
            " scrolling="no" width="100%" frameborder=0
            id="kuranEmbed${ayet.verseKey}"
            allowtransparency="true"
            src="https://kuran.yasireymen.com/embed?sure=${ayet.verseKey.split(":")[0]}&ayet=${ayet.verseNumber}&meal=${mealName}"
            frameborder="0"></iframe>
            `;
            /*const embedCode = `<div class="embedded-verse"><style>
                    @font-face {
                        font-family: 'Kitab';
                        src: url('https://kuran.yasireymen.com/Kitab-Bold.ttf') format('truetype');
                        font-weight: 700;
                        font-style: normal;
                        font-display: swap;
                    }
                    @font-face {
                        font-family: 'StackSansNotch';
                        src: url('https://kuran.yasireymen.com/StackSansNotch-Bold.ttf') format('truetype');
                        font-weight: 700;
                        font-style: normal;
                        font-display: swap;
                    }
                </style>
                <div style="
                    font-family: 'Kitab', 'Noto Naskh Arabic', serif;
                    font-size: 32px;
                    font-weight: 700;
                    margin: 5px 0;
                    text-align: center;
                ">${ayet.arabic}</div>
                <div style="
                    font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Noto Sans', sans-serif;
                    font-size: 16px;
                    margin-bottom: 10px;
                    text-align: center;
                ">${result}</div>
                <div style="
                    font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Noto Sans', sans-serif;
                    font-size: 12px;
                    font-weight: bold;
                    color: #555;
                    margin-bottom: 5px;
                    text-align: center;
                ">Ayet ${ayet.verseNumber} (${ayet.verseKey})</div>
            </div>`;*/
            
            navigator.clipboard.writeText(embedCode)
                .then(() => {
                    embedBtn.textContent = "ğŸ‘ GÃ¶mme Kodu KopyalandÄ±";
                    setTimeout(function(){embedBtn.textContent = "ğŸ”— GÃ¶m"}, 3000);
                })
                .catch(err => alert('Kopyalama hatasÄ±: ' + err));
        })

        const openNewTabBtn = document.createElement('button');
        openNewTabBtn.textContent = 'ğŸ–¥ Yeni Sekmede AÃ§';
        openNewTabBtn.classList.add('btn');
        openNewTabBtn.classList.add("opennewtab");
        openNewTabBtn.style.fontSize = '16px';
        openNewTabBtn.style.padding = '6px 12px';
        openNewTabBtn.style.marginTop = '5px';
        openNewTabBtn.style.marginLeft = '5px';

        openNewTabBtn.addEventListener('click', () => {
            const mealName = mealSelect.value; // veya seÃ§tiÄŸin meal deÄŸiÅŸkeni
            const url = `/embed?sure=${ayet.verseKey.split(":")[0]}&ayet=${ayet.verseNumber}&meal=${mealName}`;
            window.open(url, '_blank'); // Yeni sekmede aÃ§
        });

        verseDiv.appendChild(number);
        verseDiv.appendChild(arabic);
        verseDiv.appendChild(tevil);
        verseDiv.appendChild(markBtn);
        verseDiv.appendChild(shareBtn);
        verseDiv.appendChild(embedBtn);
        verseDiv.appendChild(openNewTabBtn);

        verseDiv.id = `verse${ayet.verseKey}`;

        container.appendChild(verseDiv);

        removeDuplicateIds();
        removeZiyade();
    }
    removeDuplicateIds();
    removeZiyade();

    container.style.display = "block";

    // Sonunda scrollu uygula
    const scrollTop = localStorage.getItem(`${sureSelect.value}.scrollTop`);
    if (getQueryParam("ayet")) {
        scrollToAyet();
    } else if(scrollTop) window.scrollTo({
        top: parseInt(scrollTop),
        behavior: "smooth"
    });
}




function highlightText(text, query){
    if(!query) return text;
    const escaped=query.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&');
    const regex=new RegExp(escaped,'gi');
    return text.replace(regex,match=>`<mark>${match}</mark>`);
}

sureSelect.addEventListener('change',(e)=>{
    const chapter=e.target.value;
    searchInput.value='';
    loadVerse(chapter, mealSelect.value);
    localStorage.setItem('lastChapter', chapter);
    window.location.href = "./kuran"
});

mealSelect.addEventListener("change",(e)=> {
    const meal = e.target.value;
    loadVerse(sureSelect.value, meal);
})

// Arama
searchInput.addEventListener('input',(e)=>{
    const query=e.target.value.toLowerCase();
    if(!query) return renderVerses(allVerses);
    const filtered=allVerses.filter(ayet=>
        ayet.arabic.toLowerCase().includes(query) ||
        ayet.english.toLowerCase().includes(query) ||
        ayet.verseNumber.toString().includes(query)
    );
    renderVerses(filtered,query);
});

// Scroll pozisyonu kaydet
window.addEventListener('beforeunload',()=>{
    localStorage.setItem(`${sureSelect.value}.scrollTop`, window.scrollY);
});

// KaldÄ±ÄŸÄ± yerden devam
const lastChapter = localStorage.getItem('lastChapter');
if(lastChapter){
    sureSelect.value = lastChapter;
    loadVerse(lastChapter, mealSelect.value);
}else{
    window.location.href = "./";
}



const urlSure = getQueryParam('sure');
if (urlSure && !isNaN(urlSure) && urlSure >= 1 && urlSure <= 114) {
    sureSelect.value = urlSure;
    loadVerse(urlSure, mealSelect.value);
} else {
    // KaldÄ±ÄŸÄ± yerden devam veya tÃ¼m Kur'an
    const lastChapter = localStorage.getItem('lastChapter');
    if(lastChapter){
        sureSelect.value = lastChapter;
        loadVerse(lastChapter, mealSelect.value);
    } else {
        window.location.href = "./";
    }
}

removeDuplicateIds();
removeZiyade();

const toTopBtn = document.getElementById("toTopBtn");

// TÄ±klayÄ±nca yukarÄ± kaydÄ±r
toTopBtn.addEventListener("click", () => {
    window.scrollTo({
        top: 0,
        behavior: "smooth"
    });
});

// Scroll takip â€” belli bir mesafeden sonra butonu gÃ¶ster
window.addEventListener("scroll", () => {
    if (window.scrollY > 250) {
        toTopBtn.classList.add("show");
    } else {
        toTopBtn.classList.remove("show");
    }
});

function updateStreak() {
    const today = new Date().toISOString().split("T")[0];
    const lastDate = localStorage.getItem("lastDate");
    let streak = parseInt(localStorage.getItem("streak") || "0", 10);

    if (!lastDate) {
        // Ä°lk gÃ¼n
        streak = 1;
        localStorage.setItem("streak", streak);
        localStorage.setItem("lastDate", today);
        return;
    }

    const diffDays = (new Date(today) - new Date(lastDate)) / 86400000;

    if (diffDays === 1) {
        streak++;
        localStorage.setItem("streak", streak);
        localStorage.setItem("lastDate", today);
    } else if (diffDays > 1) {
        // GÃ¼n atlandÄ±ysa istersen sÄ±fÄ±rlamak yerine yine 1'den baÅŸlatabilirsin
        streak = 1;
        localStorage.setItem("streak", streak);
        localStorage.setItem("lastDate", today);
    }
}

updateStreak();



</script>
<script src="devmode.js"></script>
<!--div class="loadScreen">
    <h1>...</h1>
</div>
<script src="/assets/js/loadScreen.js"></script-->
</body>
</html>
